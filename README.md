# Delivery Bag

## Обзор проекта

**Delivery Bag** — Android-приложение для мониторинга и управления устройствами через Bluetooth. Приложение принимает данные с Arduino, оснащённой различными датчиками (например, температуры, датчик Холла, акселерометр), и отображает их в удобном интерфейсе. Основные возможности:

- Подключение к Arduino через Bluetooth
- Получение и отображение данных датчиков
- Определение геопозиции устройства
- Логирование событий с привязкой к координатам
- Интеграция с картографическим модулем (osmdroid)

## Файловая структура

Проект имеет следующую файловую структуру:

```plaintext
├── bluetooth
│   └── BluetoothHelper.kt
├── location
│   └── LocationManager.kt
├── log
│   └── LogModule.kt
├── MainActivity.kt
├── map
│   └── MapModule.kt
├── permissions
│   └── PermissionHelper.kt
├── ui
│   ├── control
│   │   ├── AppTopBar.kt
│   │   └── ControlPanel.kt
│   ├── LogScreen.kt
│   ├── MainScreen.kt
│   ├── map_log
│   │   ├── MapModal.kt
│   │   └── MapOverlay.kt
│   ├── MapScreen.kt
│   └── theme
│       ├── Color.kt
│       ├── Theme.kt
│       └── Type.kt
└── utils
    └── LogHelper.kt
```

## Архитектура приложения

Приложение разделено на модули, каждый из которых отвечает за свою функциональность:

- **BluetoothHelper**  
  Управляет Bluetooth-соединением: выбор устройства, установка соединения, обмен данными.

- **LocationManager**  
  Получает и обновляет геопозицию с использованием Google Location Services.

- **LogModule**  
  Логирует ключевые события приложения, такие как изменение состояния датчиков, ошибки и системные уведомления.

- **UI Модули**  
  Отвечают за визуальное отображение данных: главные экраны, панели управления, карты и тема оформления.

- **MapModule**  
  Интегрирует карты (с использованием osmdroid), настраивает кэш и отвечает за отображение картографических данных.

- **PermissionHelper**  
  Обеспечивает обработку и запрос всех необходимых разрешений для корректной работы приложения.

- **Utils**  
  Вспомогательные функции, например, для логирования или форматирования данных.

## Интеграция с Arduino

Для обмена данными между Arduino и приложением используется строковый протокол с разделителями (запятыми). Ожидается, что входящая строка содержит 6 параметров:

1. **Уровень заряда батареи**
2. **Температура верхнего отсека**
3. **Температура нижнего отсека**
4. **Состояние датчика Холла**
5. **Функциональное состояние устройства**
6. **Данные акселерометра**

При передаче данных от Arduino строка содержит шесть параметров, разделённых запятыми. Каждый параметр имеет свои границы значений и интерпретируется в соответствии с логикой приложения.

### 1. Уровень заряда батареи (0–100)

Передаётся в виде целого числа от `0` до `100`, указывающего процент заряда аккумулятора. Если значение выходит за эти границы, оно считается некорректным и логируется как ошибка. Каждое изменение уровня заряда, кратное `10%`, фиксируется в логе. При снижении ниже критических значений (`5%`, `10%`, `25%`), приложение записывает предупреждающее событие.

### 2. Температура верхнего отсека

Передаётся в виде числа с плавающей точкой, представляющего температуру (°C) верхнего отсека устройства. Логика приложения отслеживает превышение заданных порогов: `40°C`, `50°C`, `60°C`, записывая их в лог. Если данные отсутствуют или имеют некорректный формат, используется последнее сохранённое значение.

### 3. Температура нижнего отсека

Также передаётся в виде числа с плавающей точкой и отображает температуру нижнего отсека. Приложение фиксирует достижение критических порогов: `5°C`, `10°C`, `15°C`. При выходе значений за реалистичные пределы они игнорируются, а в лог записывается ошибка.

### 4. Состояние датчика Холла (1 — закрыта, 0 — открыта)

Передаётся в виде `1` (сумка закрыта) или `0` (сумка открыта). Изменения фиксируются в логе: `"Сумка закрыта"` или `"Сумка открыта"`, предотвращая дублирование записей при частых переключениях состояния. Если передано некорректное значение, параметр устанавливается в `"Неизвестно"`.

### 5. Функциональное состояние устройства

Передаётся в виде числового значения, которое ранее рассчитывалось путём суммирования активных функций (свет, тепло, холод). Однако такой метод не позволяет точно определить, какая именно функция включена, поэтому теперь приложение само отслеживает состояние каждой функции и обновляет UI на основе локального хранения данных.

Из-за этого может возникнуть **рассинхронизация** между приложением и Arduino. Например, если устройство было перезапущено, кнопка в интерфейсе может отображаться как неактивная, хотя функция всё ещё работает на Arduino. Чтобы избежать таких расхождений, необходимо доработать логику на бэкенде — передавать точный статус каждой функции отдельно, а не в виде суммарного значения.

### 6. Данные акселерометра

Передаётся в виде числа с плавающей точкой, определяющего уровень вибрации. Значение анализируется и интерпретируется следующим образом:

- `>2.5` или `<-2.5` — **Экстремальная тряска** (логируется с указанием точного значения).
- `>1.0` или `<-1.0` — **Сильная тряска**.
- `>0.5` или `<-0.5` — **Слабая тряска**.
- `≤0.5` и `≥-0.5` — **В покое**.

> Каждое изменение состояния тряски сопровождается записью в лог.
>
> **Если данные переданы в некорректном формате, отображается предупреждение, а приложение продолжает использовать предыдущее корректное значение.**
